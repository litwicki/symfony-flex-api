---
- name: fix proxy for Ubuntu
  shell: echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null

- name: Add repository for Ansible
  apt_repository: repo="ppa:ansible/ansible" state=present update_cache=yes

- name: Install System Packages
  apt: pkg={{ item }} state=latest
  with_items: "{{ server.packages }}"

- name: Purge stuff
  apt: pkg={{ item }} state=absent autoremove=yes
  with_items: "{{ server.remove_packages }}"

- name: Install php7 Packages
  apt: pkg={{ item }} state=latest
  with_items: "{{ server.php7_packages }}"

- name: Install OAUTH PHP package
  pear: name=pecl/oauth state=present

- name: Configure the timezone
  template: src=timezone.tpl dest=/etc/timezone

- name: More Configure the timezone
  file: src=/usr/share/zoneinfo/{{server.timezone}} dest=/etc/localtime state=link force=yes backup=yes

- name: Set default system language pack
  shell: locale-gen {{server.locale}}

#- name: set the session save path to our api path
#  lineinfile: dest=/etc/php/7.0/fpm/php.ini
#              line='session.save_path = "/var/www/tavro/api/var/sessions"'
#              state=present

# ########################################################################
#  There may be a better way of doing this, but it dramatically helps
#  with memory intensive tasks like running a `composer install`
# ########################################################################

- name: setup swap file
  become: true
  become_user: root
  command: dd if=/dev/zero of=/swapfile bs=1024 count=512k
  args:
    creates: /swapfile

- name: make swapfile
  become: true
  become_user: root
  command: mkswap /swapfile
  args:
    creates: /swapfile

- name: swapon
  become: true
  become_user: root
  command: swapon /swapfile
  args:
    creates: /swapfile